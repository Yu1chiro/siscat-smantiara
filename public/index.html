<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Pelanggaran Siswa - SMAN 3 Singaraja</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CDN SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            '50': '#eff6ff',
                            '100': '#dbeafe',
                            '200': '#bfdbfe',
                            '300': '#93c5fd',
                            '400': '#60a5fa',
                            '500': '#3b82f6',
                            '600': '#2563eb',
                            '700': '#1d4ed8',
                            '800': '#1e40af',
                            '900': '#1e3a8a'
                        },
                        education: {
                            '50': '#f0f9ff',
                            '100': '#e0f2fe',
                            '200': '#bae6fd',
                            '300': '#7dd3fc',
                            '400': '#38bdf8',
                            '500': '#0ea5e9',
                            '600': '#0284c7',
                            '700': '#0369a1',
                            '800': '#075985',
                            '900': '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
</head>
<style>
    h1,
    h2,
    h3,
    p {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;

    }

    a {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;



    }

    button {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;



    }

    div {
        font-family: "Montserrat", sans-serif !important;


    }
</style>

<body class="bg-gray-50">
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">

            <!-- Logo + Brand -->
            <a href="/" class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center">
                    <img loading="lazy" decoding="async"
                        src="https://1mjtjv6snj.ucarecd.net/9c3fb829-d415-4a23-a7ba-8a9e22a3df2c/images.png" alt="Logo">
                </div>
                <span class="text-xl font-bold text-slate-800">SMAN 3 Singaraja</span>
            </a>
            <div class="hidden md:flex space-x-6 items-center">
             <a class="block text-slate-600 hover:text-primary transition" href="#statistik">Statistik</a>
             <a class="block text-slate-600 hover:text-primary transition" href="/form-aduan">Laporkan Aduan</a>

            </div>
            <button id="mobile-menu-button" class="md:hidden">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-6 pt-2 pb-4 space-y-2">
             <a class="block text-slate-600 hover:text-primary transition" href="#statistik">Statistik</a>
             <a class="block text-slate-600 hover:text-primary transition" href="/form-aduan">Laporkan Aduan</a>
        </div>
    </nav>
    <script>
         // === Fungsi Mobile Menu ===
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
    </script>


    <!-- Hero Section -->
    <section id="home"
        style="background-image: url('https://6afuiqe8xb.ucarecd.net/745d6e45-2916-4c65-990f-39e4fedd3b23/unnamed.webp');"
        class="pt-28 bg-cover bg-center pb-20 text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-gray-700/50"></div>
        <div
            class="container mx-auto px-4 flex flex-col items-center justify-center text-center relative z-10 min-h-[70vh]">
            <div class="max-w-4xl">
                <h1 class="text-3xl md:text-5xl lg:text-6xl font-bold mb-6 leading-tight">Sistem Pengaduan & Catatan
                    Pelanggaran Siswa SMAN 3 Singaraja</h1>
                <p class="text-lg md:text-xl mb-8 opacity-90 max-w-3xl mx-auto">Layanan terpadu untuk melaporkan dan
                    mencatat pelanggaran siswa dalam upaya menciptakan lingkungan sekolah yang lebih disiplin dan
                    bertanggung jawab.</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="#cari"
                        class="bg-white text-blue-700 px-6 py-3 md:px-8 md:py-4 rounded-xl font-bold hover:bg-blue-50 transition-all duration-300 inline-block text-center shadow-lg hover:shadow-xl transform hover:scale-105">Cari
                        Nama Siswa</a>
                    <a href="/form-aduan" target="_blank"
                        class="bg-red-600 text-white px-6 py-3 md:px-8 md:py-4 rounded-xl font-bold hover:bg-red-700 transition-all duration-300 inline-block text-center shadow-lg hover:shadow-xl transform hover:scale-105">Laporkan
                        Aduan</a>
                </div>
            </div>
        </div>
    </section>
    <!-- Pencarian Section -->
    <section id="cari" class="py-16 bg-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Cari Data Siswa</h2>

            <div class="max-w-2xl mx-auto mb-12">
                <div class="flex">
                    <input type="text" id="searchInput" placeholder="Masukkan nama siswa..."
                        class="flex-grow px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <button id="searchButton"
                        class="bg-primary-600 text-white px-6 py-3 rounded-r-lg hover:bg-primary-700 transition duration-300">
                        Cari
                    </button>
                </div>
            </div>

            <!-- Hasil Pencarian -->
            <div id="searchResults" class="hidden bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Hasil Pencarian</h3>
                <div id="studentInfo" class="mb-6"></div>
                <div id="violationList"></div>
            </div>
        </div>
    </section>
    <!-- Statistik Section -->
    <section id="statistik" class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Statistik Pelanggaran</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <!-- Jenis Pelanggaran Paling Sering -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Jenis Pelanggaran Paling Sering</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="jenisPelanggaranChart"></canvas>
                    </div>
                </div>

                <!-- Pelanggaran Per Kelas -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Pelanggaran Per Kelas</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="kelasChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tren Pelanggaran Bulanan -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Tren Pelanggaran</h3>
                    <div class="bg-gray-200 p-1 rounded-lg flex space-x-1">
                        <button id="weeklyBtn"
                            class="px-3 py-1 text-sm font-semibold rounded-md transition bg-white text-blue-600 shadow">Mingguan</button>
                        <button id="monthlyBtn"
                            class="px-3 py-1 text-sm font-semibold rounded-md transition text-gray-600">Bulanan</button>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="trenChart"></canvas>
                </div>
            </div>
        </div>
    </section>
    <section id="statistik-aduan" class="py-16 bg-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Statistik Aduan Siswa</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Rekap Status Aduan</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="statusAduanChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Tren Aduan Masuk</h3>
                        <div class="bg-gray-200 p-1 rounded-lg flex space-x-1">
                            <button id="weeklyAduanBtn"
                                class="px-3 py-1 text-sm font-semibold rounded-md transition bg-blue-600 text-white shadow">Mingguan</button>
                            <button id="monthlyAduanBtn"
                                class="px-3 py-1 text-sm font-semibold rounded-md transition text-gray-600">Bulanan</button>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="trenAduanChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-xl font-bold">Catatan Pelanggaran Siswa</h3>
                    <p class="text-gray-400">SMAN 3 Singaraja</p>
                </div>
                <div>
                    <p class="text-gray-400">Â© 2023 SMAN 3 Singaraja. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal untuk Detail Pelanggaran -->
    <div id="detailModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Detail Pelanggaran</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="py-4"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Variabel Global ---
            let allViolations = [];
            let allAduan = [];
            let jenisPelanggaranChartInstance, kelasChartInstance, trenChartInstance;
            let statusAduanChartInstance, trenAduanChartInstance;
// --- FUNGSI PENCARIAN SISWA & MODAL (YANG HILANG) ---

            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResultsContainer = document.getElementById('searchResults');
            const studentInfoContainer = document.getElementById('studentInfo');
            const violationListContainer = document.getElementById('violationList');

            // Modal elements
            const detailModal = document.getElementById('detailModal');
            const closeModalBtn = document.getElementById('closeModal');
            const modalContent = document.getElementById('modalContent');

            function handleSearch() {
                const query = searchInput.value.trim().toLowerCase();
                if (!query) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Oops...',
                        text: 'Silakan masukkan nama siswa terlebih dahulu.',
                    });
                    return;
                }

                // Filter dari data global `allViolations` yang sudah di-fetch
                const filteredViolations = allViolations.filter(v => 
                    v.nama && v.nama.toLowerCase().includes(query)
                );

                if (filteredViolations.length > 0) {
                    // Ambil data siswa dari entri pertama (nama dan kelas akan sama)
                    const studentData = filteredViolations[0];
                    studentInfoContainer.innerHTML = `
                        <p class="text-lg"><span class="font-semibold">Nama:</span> ${studentData.nama}</p>
                        <p class="text-lg"><span class="font-semibold">Kelas:</span> ${studentData.kelas}</p>
                    `;

                    // Buat daftar riwayat pelanggaran
                    violationListContainer.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Riwayat Pelanggaran:</h4>
                        <div class="space-y-3">
                            ${filteredViolations.map(v => `
                                <div class="p-4 border rounded-lg bg-gray-50 flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-red-600">${v.jenis_pelanggaran}</p>
                                        <p class="text-sm text-gray-500">${new Date(v.timestamp).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                    </div>
                                    <button class="hidden detail-btn text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" data-id="${v.id}">
                                        Detail
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    searchResultsContainer.classList.remove('hidden'); // Tampilkan hasil
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Tidak Ditemukan',
                        text: `Siswa dengan nama yang mengandung "${searchInput.value}" tidak ditemukan.`,
                    });
                    searchResultsContainer.classList.add('hidden'); // Sembunyikan jika tidak ada hasil
                }
            }

            // --- Event Listener untuk Pencarian ---
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });

            // --- Event Listener untuk Modal ---
            // Menggunakan event delegation karena tombol detail dibuat dinamis
            searchResultsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('detail-btn')) {
                    const violationId = event.target.getAttribute('data-id');
                    const violation = allViolations.find(v => v.id === violationId);
                    if (violation) {
                        modalContent.innerHTML = `
                            <p><strong class="font-semibold">Nama:</strong> ${violation.nama}</p>
                            <p><strong class="font-semibold">Kelas:</strong> ${violation.kelas}</p>
                            <p><strong class="font-semibold">Tanggal:</strong> ${new Date(violation.timestamp).toLocaleString('id-ID')}</p>
                            <p><strong class="font-semibold">Jenis Pelanggaran:</strong> ${violation.jenis_pelanggaran}</p>
                            <hr class="my-3">
                            <p><strong class="font-semibold">Catatan:</strong></p>
                            <p class="mt-1 whitespace-pre-wrap">${violation.catatan || 'Tidak ada catatan.'}</p>
                        `;
                        detailModal.classList.remove('hidden');
                    }
                }
            });

            closeModalBtn.addEventListener('click', () => {
                detailModal.classList.add('hidden');
            });

            // Menutup modal jika klik di luar area konten
            detailModal.addEventListener('click', (event) => {
                if (event.target === detailModal) {
                    detailModal.classList.add('hidden');
                }
            });
            // --- Fungsi Fetch Utama ---
            async function fetchAllData() {
                try {
                    const [pelanggaranRes, aduanRes] = await Promise.all([
                        fetch('/api/pelanggaran/list'),
                        fetch('/api/aduan/list')
                    ]);

                    if (!pelanggaranRes.ok || !aduanRes.ok) throw new Error('Gagal mengambil salah satu data');

                    const pelanggaranData = await pelanggaranRes.json();
                    const aduanData = await aduanRes.json();

                    allViolations = Array.isArray(pelanggaranData) ? pelanggaranData.filter(v => v.timestamp) : [];
                    allAduan = Array.isArray(aduanData) ? aduanData.filter(a => a.timestamp) : [];

                    if (allViolations.length > 0) {
                        renderJenisPelanggaranChart();
                        renderKelasChart();
                        renderTrendChart('weekly');
                    }
                    if (allAduan.length > 0) {
                        renderStatusAduanChart(); // Fungsi ini yang kita perbaiki
                        renderTrenAduanChart('weekly');
                    }
                } catch (error) {
                    console.error('Gagal memuat data:', error);
                }
            }

            // --- Fungsi Helper ---
            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return weekNo;
            };

            // --- FUNGSI GRAFIK PELANGGARAN ---

            function renderJenisPelanggaranChart() {
                const ctx = document.getElementById('jenisPelanggaranChart').getContext('2d');
                if (jenisPelanggaranChartInstance) jenisPelanggaranChartInstance.destroy();
                const violationCounts = allViolations.reduce((acc, v) => { acc[v.jenis_pelanggaran] = (acc[v.jenis_pelanggaran] || 0) + 1; return acc; }, {});
                const sorted = Object.entries(violationCounts).sort((a, b) => b[1] - a[1]).slice(0, 7);
                jenisPelanggaranChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(v => v[0]),
                        datasets: [{
                            label: 'Jumlah Pelanggaran',
                            data: sorted.map(v => v[1]),
                            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#6366f1', '#a855f7'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            }

            function renderKelasChart() {
                const ctx = document.getElementById('kelasChart').getContext('2d');
                if (kelasChartInstance) kelasChartInstance.destroy();
                const classCounts = allViolations.reduce((acc, v) => { acc[v.kelas] = (acc[v.kelas] || 0) + 1; return acc; }, {});
                kelasChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(classCounts),
                        datasets: [{
                            data: Object.values(classCounts),
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            function renderTrendChart(timeframe) {
                const ctx = document.getElementById('trenChart').getContext('2d');
                if (trenChartInstance) trenChartInstance.destroy();
                const dataByTime = {};
                allViolations.forEach(v => {
                    const date = new Date(v.timestamp);
                    let key = (timeframe === 'weekly') ? `${date.getFullYear()}-W${getWeekNumber(date)}` : `${date.toLocaleString('id-ID', { month: 'long' })} ${date.getFullYear()}`;
                    dataByTime[key] = (dataByTime[key] || 0) + 1;
                });
                const sortedKeys = Object.keys(dataByTime).sort((a, b) => {
                    const [aMonth, aYear] = a.includes('-W') ? [parseInt(a.split('-W')[1]), parseInt(a.split('-W')[0])] : [new Date(Date.parse(a.split(' ')[0] + " 1, 2012")).getMonth(), parseInt(a.split(' ')[1])];
                    const [bMonth, bYear] = b.includes('-W') ? [parseInt(b.split('-W')[1]), parseInt(b.split('-W')[0])] : [new Date(Date.parse(b.split(' ')[0] + " 1, 2012")).getMonth(), parseInt(b.split(' ')[1])];
                    if (aYear !== bYear) return aYear - bYear;
                    return aMonth - bMonth;
                });
                trenChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedKeys.map(k => k.includes('-W') ? `Minggu ${k.split('-W')[1]}` : k),
                        datasets: [{
                            label: 'Jumlah Pelanggaran',
                            data: sortedKeys.map(k => dataByTime[k]),
                            borderColor: '#1d4ed8', backgroundColor: 'rgba(30, 64, 175, 0.2)', fill: true, tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            }

            // --- FUNGSI GRAFIK ADUAN (BAGIAN YANG DIPERBAIKI) ---

            function renderStatusAduanChart() {
                const ctx = document.getElementById('statusAduanChart').getContext('2d');
                if (statusAduanChartInstance) statusAduanChartInstance.destroy();

                const statusCounts = allAduan.reduce((acc, aduan) => {
                    const status = aduan.status || 'Baru'; // Default ke 'Baru' jika kosong
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(statusCounts);
                const data = Object.values(statusCounts);

                statusAduanChartInstance = new Chart(ctx, {
                    type: 'bar', // Tipe tetap 'bar'
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Aduan',
                            data: data,
                            // Menggunakan palet warna yang sama dengan grafik jenis pelanggaran
                            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#0ea5e9', '#6366f1', '#a855f7'],
                        }]
                    },
                    // Menggunakan options yang sama persis dengan grafik jenis pelanggaran (bar vertikal)
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            function renderTrenAduanChart(timeframe) {
                const ctx = document.getElementById('trenAduanChart').getContext('2d');
                if (trenAduanChartInstance) trenAduanChartInstance.destroy();
                const dataByTime = {};
                allAduan.forEach(aduan => {
                    const date = new Date(aduan.timestamp);
                    let key = (timeframe === 'weekly') ? `${date.getFullYear()}-W${getWeekNumber(date)}` : `${date.toLocaleString('id-ID', { month: 'long' })} ${date.getFullYear()}`;
                    dataByTime[key] = (dataByTime[key] || 0) + 1;
                });
                const sortedKeys = Object.keys(dataByTime).sort((a, b) => {
                    const [aMonth, aYear] = a.includes('-W') ? [parseInt(a.split('-W')[1]), parseInt(a.split('-W')[0])] : [new Date(Date.parse(a.split(' ')[0] + " 1, 2012")).getMonth(), parseInt(a.split(' ')[1])];
                    const [bMonth, bYear] = b.includes('-W') ? [parseInt(b.split('-W')[1]), parseInt(b.split('-W')[0])] : [new Date(Date.parse(b.split(' ')[0] + " 1, 2012")).getMonth(), parseInt(b.split(' ')[1])];
                    if (aYear !== bYear) return aYear - bYear;
                    return aMonth - bMonth;
                });
                trenAduanChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedKeys.map(k => k.includes('-W') ? `Minggu ${k.split('-W')[1]}` : k),
                        datasets: [{
                            label: 'Jumlah Aduan',
                            data: sortedKeys.map(k => dataByTime[k]),
                            borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            }

            // --- Event Listeners ---
            document.getElementById('weeklyBtn').addEventListener('click', () => {
                renderTrendChart('weekly');
                document.getElementById('weeklyBtn').classList.add('bg-white', 'text-blue-600', 'shadow');
                document.getElementById('monthlyBtn').classList.remove('bg-white', 'text-blue-600', 'shadow');
            });
            document.getElementById('monthlyBtn').addEventListener('click', () => {
                renderTrendChart('monthly');
                document.getElementById('monthlyBtn').classList.add('bg-white', 'text-blue-600', 'shadow');
                document.getElementById('weeklyBtn').classList.remove('bg-white', 'text-blue-600', 'shadow');
            });

            document.getElementById('weeklyAduanBtn').addEventListener('click', () => {
                renderTrenAduanChart('weekly');
                document.getElementById('weeklyAduanBtn').classList.add('bg-blue-600', 'text-white', 'shadow');
                document.getElementById('monthlyAduanBtn').classList.remove('bg-blue-600', 'text-white', 'shadow');
            });
            document.getElementById('monthlyAduanBtn').addEventListener('click', () => {
                renderTrenAduanChart('monthly');
                document.getElementById('monthlyAduanBtn').classList.add('bg-blue-600', 'text-white', 'shadow');
                document.getElementById('weeklyAduanBtn').classList.remove('bg-blue-600', 'text-white', 'shadow');
            });

            // --- Inisialisasi ---
            fetchAllData();
        });
    </script>
</body>

</html>